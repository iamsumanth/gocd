/*
 * Copyright 2016 ThoughtWorks, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

var m = require('mithril');
var s = require('string-plus');

var SortHeaderWidget = {
  view: function (vnode) {
    return (
      <label class="agents-table-header"
             onclick={vnode.attrs.toggleSortingOrder.bind(vnode.state, vnode.attrs.attrName)}>{vnode.attrs.attrLabel}
        <div class={"sort " + vnode.attrs.sortClass(vnode.attrs.attrName)}>
          <span class="up"/>
          <span class="down"/>
        </div>
      </label>
    );
  }
};

var AgentsTableHeader = {

  oninit: function (vnode) {

    var currentlySortedOn = function () {
      return s.defaultToIfBlank(m.route.param('sortBy'), 'agentState');
    };

    var currentlyOrderdOn = function () {
      return s.defaultToIfBlank(m.route.param('orderBy'), 'asc');
    };

    function tableSortedOnAttribute(attrName) {
      return currentlySortedOn() === attrName;
    }

    this.sortClass = function (attrName) {
      return tableSortedOnAttribute(attrName) ? currentlyOrderdOn() : '';
    };

    this.toggleSortingOrder = function (attrName) {
      var sortingOrder = 'asc';

      if (tableSortedOnAttribute(attrName) && currentlyOrderdOn() === 'asc') {
        sortingOrder = 'desc';
      }

      vnode.attrs.sortBy(attrName, sortingOrder);
    }
  },

  view: function (vnode) {
    var selectAllAgentsCheckbox;
    if (vnode.attrs.isUserAdmin) {
      selectAllAgentsCheckbox = (
        <input type="checkbox"
               class="select-agent"
               checked={vnode.attrs.checkboxValue()}
               onclick={m.withAttr('checked', vnode.attrs.onCheckboxClick)}/>
      );
    }
    return (
      <thead>
      <tr>
        <th>
          {selectAllAgentsCheckbox}
        </th>
        <th>
          <SortHeaderWidget attrName='hostname' attrLabel='Agent Name' sortBy={vnode.attrs.sortBy}
                            sortClass={vnode.state.sortClass}
                            toggleSortingOrder={vnode.state.toggleSortingOrder}/>
        </th>
        <th>
          <SortHeaderWidget attrName='sandbox' attrLabel='Sandbox' sortBy={vnode.attrs.sortBy}
                            sortClass={vnode.state.sortClass}
                            toggleSortingOrder={vnode.state.toggleSortingOrder}/>
        </th>
        <th>
          <SortHeaderWidget attrName='operatingSystem' attrLabel='OS' sortBy={vnode.attrs.sortBy}
                            sortClass={vnode.state.sortClass}
                            toggleSortingOrder={vnode.state.toggleSortingOrder}/>
        </th>
        <th>
          <SortHeaderWidget attrName='ipAddress' attrLabel='IP Address' sortBy={vnode.attrs.sortBy}
                            sortClass={vnode.state.sortClass}
                            toggleSortingOrder={vnode.state.toggleSortingOrder}/>
        </th>
        <th>
          <SortHeaderWidget attrName='agentState' attrLabel='Status' sortBy={vnode.attrs.sortBy}
                            sortClass={vnode.state.sortClass}
                            toggleSortingOrder={vnode.state.toggleSortingOrder}/>
        </th>
        <th>
          <SortHeaderWidget attrName='freeSpace' attrLabel='Free Space' sortBy={vnode.attrs.sortBy}
                            sortClass={vnode.state.sortClass}
                            toggleSortingOrder={vnode.state.toggleSortingOrder}/>
        </th>
        <th>
          <SortHeaderWidget attrName='resources' attrLabel='Resources' sortBy={vnode.attrs.sortBy}
                            sortClass={vnode.state.sortClass}
                            toggleSortingOrder={vnode.state.toggleSortingOrder}/>
        </th>
        <th>
          <SortHeaderWidget attrName='environments' attrLabel='Environments' sortBy={vnode.attrs.sortBy}
                            sortClass={vnode.state.sortClass}
                            toggleSortingOrder={vnode.state.toggleSortingOrder}/>
        </th>
      </tr>
      </thead>
    );
  }
};

module.exports = AgentsTableHeader;
